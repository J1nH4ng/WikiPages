import{_ as r,C as i,c as d,o as c,aq as e,j as a,G as n,a as l}from"./chunks/framework.pQnWedaC.js";const x=JSON.parse('{"title":"反向代理服务器的安装配置","description":"反向代理服务器的安装配置文档","frontmatter":{"title":"反向代理服务器的安装配置","editLink":true,"description":"反向代理服务器的安装配置文档","layout":"doc","head":[["meta",{"name":"keywords","content":"Nginx, Proxy"}]],"outline":"deep","prev":{"text":null,"link":null},"next":{"text":null,"link":null}},"headers":[],"relativePath":"posts/2d22a002.md","filePath":"docs/proxy/reverse-proxy-nginx.md","lastUpdated":1745309093000}'),o={name:"posts/2d22a002.md"},b={id:"完整的-nginx-conf-文件",tabindex:"-1"},g={href:"/files/nginx/nginx.conf",download:"nginx.conf"};function y(E,s,u,m,A,F){const p=i("Badge"),t=i("Icon"),h=i("NolebaseGitContributors"),k=i("NolebaseGitChangelog");return c(),d("div",null,[s[5]||(s[5]=e('<h1 id="反向代理服务器的安装配置-nginx" tabindex="-1">反向代理服务器的安装配置（Nginx） <a class="header-anchor" href="#反向代理服务器的安装配置-nginx" aria-label="Permalink to &quot;反向代理服务器的安装配置（Nginx）&quot;">​</a></h1><div class="important custom-block github-alert"><p class="custom-block-title">特别注意：</p><p>如果有 LoadBalance 硬件的情况下，这里的所有配置可以在 LoadBalance 硬件上进行配置，所以这里的所有配置默认为上游没有 LoadBalance 硬件的情况下进行的安装配置。</p><p>在上游的硬件支持的情况不完全的情况下，可以配置成三层的反向代理，并根据需要选择性的配置接下来的部分内容。</p></div><p>反向代理服务器位于应用服务器的上游，主要将内部服务进行代理从而不暴露真实的业务端口并根据域名和路由来处理外部流量，这里使用 Nginx 作为反向代理服务器，其具体负责处理的内容如下所示：</p><ul><li>SSL 证书卸载</li><li>金丝雀发布</li><li>负载均衡</li><li>访问控制</li><li>动静分离</li></ul>',4)),a("p",null,[s[0]||(s[0]=l("并且，通过与 Lua 和 Redis 结合，可以实现更多更强大的功能： ")),n(p,{type:"tip",text:"持续更新"})]),s[6]||(s[6]=e(`<ul><li>动态黑名单</li><li>高性能缓存</li></ul><p>对于 Nginx 作为端口转发等正向代理服务器用途，会在后续知识库中具体描述，这里不做过多描述。 并且除了 Nginx 以外，还可以使用 HAproxy 作为反向代理服务器，也会在后续知识库中具体描述。</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p><a href="https://openresty.org/cn/" target="_blank" rel="noreferrer">OpenResty</a> 集成了 Nginx 和大量的 Lua 模块，如果不想使用第三方软件，可以使用官方 Nginx 并根据需要自行添加所需的 Lua 模块</p></div><p>还有一些其他的具体应用配置如下：</p><ul><li>连接数限制</li><li>防盗链配置</li><li>跨域配置</li><li>文件上传限制 <ul><li>限制上传文件大小</li><li>限制上传文件权限</li></ul></li><li>防止 SQL 注入</li><li>防止目录遍历</li></ul><p>同时，对于生产环境和测试环境还有部分不一样，具体部分如下：</p><ul><li>缓存时间配置</li><li>高可用配置</li></ul><h2 id="nginx-的安装与配置" tabindex="-1">Nginx 的安装与配置 <a class="header-anchor" href="#nginx-的安装与配置" aria-label="Permalink to &quot;Nginx 的安装与配置&quot;">​</a></h2><h3 id="nginx-的安装" tabindex="-1">Nginx 的安装 <a class="header-anchor" href="#nginx-的安装" aria-label="Permalink to &quot;Nginx 的安装&quot;">​</a></h3><p>由于两台代理服务器是作为高可用使用的，逻辑意义上相当于一台服务器，故安装和配置是完全一样的，这里只描述其中一台的操作，对于两台之间的不同之处会重点指出，除此之外，没有任何的不同操作。这里为了方便后续的配置和功能的实现，会添加大量的 Lua 模块依赖文件。</p><h4 id="安装依赖" tabindex="-1">安装依赖 <a class="header-anchor" href="#安装依赖" aria-label="Permalink to &quot;安装依赖&quot;">​</a></h4><h4 id="编译安装" tabindex="-1">编译安装 <a class="header-anchor" href="#编译安装" aria-label="Permalink to &quot;编译安装&quot;">​</a></h4><h4 id="配置-systemd-管理" tabindex="-1">配置 Systemd 管理 <a class="header-anchor" href="#配置-systemd-管理" aria-label="Permalink to &quot;配置 Systemd 管理&quot;">​</a></h4><p>安装完成后，还需要使用 Systemd 软件进行进程管理，具体的配置方法如下：</p><ol><li><p>新建 nginx.service 文件</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">vim</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> /etc/systemd/system/nginx.service</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>写入如下内容</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">[</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">Unit</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">]</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">Description</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">nginx</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">After</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">[</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">Service</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">]</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">Type</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">forking</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">ExecStart</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">/usr/local/nginx/sbin/nginx</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> -c</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> /usr/local/nginx/conf/nginx.conf</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">ExecReload</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">/usr/local/nginx/sbin/nginx</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> -s</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> reload</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">ExecStop</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">/usr/local/nginx/sbin/nginx</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> -s</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> quit</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">LimitNOFILE</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">100000</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">PrivateTmp</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">[</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">Install</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">]</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">WantedBy</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">=</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">multi-user.target</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>更新 systemd 配置</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">systemctl</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> daemon-reload</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="nginx-的配置" tabindex="-1">Nginx 的配置 <a class="header-anchor" href="#nginx-的配置" aria-label="Permalink to &quot;Nginx 的配置&quot;">​</a></h3><p>Nginx 安装完成之后，还需要修改默认的配置，使其符合业务的需要，主要的配置方面有：</p><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_0" disabled="true"><label for="cbx_0"> 性能调优</label></li><li class="task-list-item"><input type="checkbox" id="cbx_1" checked="true" disabled="true"><label for="cbx_1"> SSL 证书卸载</label></li><li class="task-list-item"><input type="checkbox" id="cbx_2" disabled="true"><label for="cbx_2"> 负载均衡配置</label></li><li class="task-list-item"><input type="checkbox" id="cbx_3" disabled="true"><label for="cbx_3"> 反向代理至业务服务器</label><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_4" checked="true" disabled="true"><label for="cbx_4"> 四层代理</label></li><li class="task-list-item"><input type="checkbox" id="cbx_5" disabled="true"><label for="cbx_5"> 七层代理</label></li></ul></li><li class="task-list-item"><input type="checkbox" id="cbx_6" checked="true" disabled="true"><label for="cbx_6"> 跨域配置</label></li><li class="task-list-item"><input type="checkbox" id="cbx_7" disabled="true"><label for="cbx_7"> 高性能缓存</label></li><li class="task-list-item"><input type="checkbox" id="cbx_8" disabled="true"><label for="cbx_8"> 安全配置</label><ul class="task-list"><li class="task-list-item"><input type="checkbox" id="cbx_9" checked="true" disabled="true"><label for="cbx_9"> 配置 HSTS</label></li><li class="task-list-item"><input type="checkbox" id="cbx_10" disabled="true"><label for="cbx_10"> 访问控制</label></li><li class="task-list-item"><input type="checkbox" id="cbx_11" checked="true" disabled="true"><label for="cbx_11"> 限制请求方式</label></li><li class="task-list-item"><input type="checkbox" id="cbx_12" checked="true" disabled="true"><label for="cbx_12"> 限制请求速率</label></li><li class="task-list-item"><input type="checkbox" id="cbx_13" checked="true" disabled="true"><label for="cbx_13"> 限制上传文件权限</label></li><li class="task-list-item"><input type="checkbox" id="cbx_14" checked="true" disabled="true"><label for="cbx_14"> 限制上传文件大小</label></li><li class="task-list-item"><input type="checkbox" id="cbx_15" disabled="true"><label for="cbx_15"> 设置防盗链</label></li><li class="task-list-item"><input type="checkbox" id="cbx_16" checked="true" disabled="true"><label for="cbx_16"> 防止 SQL 注入和 XSS 攻击</label></li><li class="task-list-item"><input type="checkbox" id="cbx_17" checked="true" disabled="true"><label for="cbx_17"> 禁止目录遍历</label></li><li class="task-list-item"><input type="checkbox" id="cbx_18" checked="true" disabled="true"><label for="cbx_18"> 禁止爬虫</label></li></ul></li><li class="task-list-item"><input type="checkbox" id="cbx_19" checked="true" disabled="true"><label for="cbx_19"> 开启监控</label></li></ul><h4 id="性能调优" tabindex="-1">性能调优 <a class="header-anchor" href="#性能调优" aria-label="Permalink to &quot;性能调优&quot;">​</a></h4><h4 id="配置-ssl-卸载" tabindex="-1">配置 SSL 卸载 <a class="header-anchor" href="#配置-ssl-卸载" aria-label="Permalink to &quot;配置 SSL 卸载&quot;">​</a></h4><p>Nginx 可以处理 HTTPS 请求，具体的配置内容如下：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">443</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> ssl</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server_name </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">wiki.4r3al.team</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 证书位置</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_certificate </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/usr/local/nginx/ca/wiki.cer</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_certificate_key </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/usr/local/nginx/ca/wiki.key</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 启用 SSL 缓存</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_session_cache </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">shared:SSL:10m</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_session_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">1h</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 使用现代加密算法</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_protocols </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">TLSv1.2 TLSv1.3</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_ciphers </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!3DES:!ADH:!RC4:!DH:!DHE</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_prefer_server_ciphers </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">on</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 启用 OCSP Stapling</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_stapling </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">on</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ssl_stapling_verify </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">on</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="配置-hsts" tabindex="-1">配置 HSTS <a class="header-anchor" href="#配置-hsts" aria-label="Permalink to &quot;配置 HSTS&quot;">​</a></h4><p>HSTS（HTTP 严格传输安全）是一种强制实施 HTTPS 连接的重要网络安全机制，同时结合 Nginx 配置 HTTP 转 HTTPS 使用，可以强制用户使用 HTTPS 协议进行访问，该配置项配置在 server 块内，具体的配置内容如下：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">80</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server_name </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">wiki.4r3al.team</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 301 重定向</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 301</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> https://</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">host</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">request_uri</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # rewrite 重定向（不推荐）</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  #rewrite ^(.*)$ https://$host$1 permanent;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">443</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> ssl</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server_name </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">wiki.4r3al.team</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # SSL 证书的设置</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  ...</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 配置 HSTS</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  add_header </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">Strict-Transport-Security </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&quot;max-age=31536000; includeSubDomains; preload&quot;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 其他的业务配置</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  ...</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>值得注意的是：</p><ul><li>这里的 <code>max-age</code> 的值是一年，如果生产使用，请先从较小的值开始，经过一段时间的检验后再逐步增大该值，例如可以从 <code>max-age=300</code> 开始，即 5min</li><li>对于 <code>includeSubDomains</code>，使用该选项之前，请确保所有的子域均已准备使用 HTTPS</li><li><code>preload</code> 表示将该配置缓存于用户的浏览器中，后续是很难撤销的，有着长期的影响，提交之前请确保已经做好了长期地维护准备</li></ul><p>可能导致的问题：</p><ul><li>需要长期监控 SSL 证书的有效性，一旦失效，影响将是严重的，会锁定用户造成严重的生产事故</li><li>一些网站的资源任然使用 HTTP 协议来加载，请考虑使用内容安全策略（CSP）标头来检测和报告混合内容</li><li>对于反向代理而已， HSTS 标头可能无法通过某些反向代理设置正确传播，需要正确配置反向代理</li><li>HSTS 会导致访问 HTTP 的开发环境变得异常困难</li></ul><h4 id="配置反向代理" tabindex="-1">配置反向代理 <a class="header-anchor" href="#配置反向代理" aria-label="Permalink to &quot;配置反向代理&quot;">​</a></h4><p>流量经过反向代理服务器后需要分流到应用服务器上，对于不同的业务需要，需要分别配置四层或七层代理，四层代理适合高性能、低延迟的场景，不解析应用层协议，仅支持转发原始数据，适用于 MySQL 的反向代理、SSH 协议、DNS 等，而七层协议则需要解析 HTTP 协议，但是支持复杂的路由和逻辑场景，适用于 Web 服务和 API 网关等。</p><h5 id="四层代理" tabindex="-1">四层代理 <a class="header-anchor" href="#四层代理" aria-label="Permalink to &quot;四层代理&quot;">​</a></h5><div class="important custom-block github-alert"><p class="custom-block-title">特别说明：</p><p>Nginx 原始的四层代理不支持修改 header 头，如果需要修改，使用 stream-lua 模块结合 lua 脚本进行修改，如果只是单纯的修改 HTTP 请求的 header 头，请先考虑使用七层代理，如果不可行的话，再使用该方式进行修改。</p></div><p>在使用四层代理之前请确保 Nginx 将 <code>stream</code> 模块正确地编入其中，使用如下命令进行查看验证：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">nginx</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> -V</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> |</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> grep</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> stream</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>对于四层代理的具体配置如下所示：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">stream</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  upstream</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> dns </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">    # 负载均衡配置</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    ...</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  upstream</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> mysql </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> unix:/xxx/mysql.socket;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    check</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> interval=3000 rise=2 fall=3 timeout=1000</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">    # 监听指定端口</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">53</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_connect_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">1s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">20s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_pass </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">dns</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">    # 监听指定端口，协议</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">    # reuseport：启用端口复用，提高性能</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">3306</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> tcp reuseport</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_connect_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">1s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">20s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_pass </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">mysql</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_next_upstream </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">error</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> timeout</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_next_upstream_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">10s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    access_log </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/var/log/nginx/access.log</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    error_log </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/var/log/nginx/error.log</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    allow </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">192.168.50.0/24</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_buffer_size </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">16k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    proxy_buffers </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">4</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 32k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h5 id="七层代理" tabindex="-1">七层代理 <a class="header-anchor" href="#七层代理" aria-label="Permalink to &quot;七层代理&quot;">​</a></h5><h4 id="配置跨域" tabindex="-1">配置跨域 <a class="header-anchor" href="#配置跨域" aria-label="Permalink to &quot;配置跨域&quot;">​</a></h4><p>跨域（CORS）：是一种基于 HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其他源（域、协议或端口），使得浏览器允许这些源访问加载自己的资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的 “预检” 请求。在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。</p><div class="tip custom-block github-alert"><p class="custom-block-title">特别说明：</p><p>请求方法，域名，端口有一个不一样都是跨域。</p></div><p>具体的配置内容如下：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">map</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> $</span><span style="--shiki-light:#907AA9;--shiki-light-font-style:italic;--shiki-dark:#C4A7E7;--shiki-dark-font-style:italic;">http_origin</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> $</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">cors_origin</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">  default</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &quot;&quot;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  ~</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">^https?://(example1\\.com|example2\\.com)$</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> $</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">http_origin</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">80</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server_name </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">_</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> / </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    if</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">request_method</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> = </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">OPTIONS) {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">      add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Origin&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> $</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">cors_origin</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">      add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Methods&#39;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &#39;GET, POST, OPTIONS&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">      add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Headers&#39;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &#39;Authorization, Content-Type&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">      add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Max-Age&#39;</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 1728000</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">      return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 204</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Origin&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> $</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">cors_origin</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Methods&#39;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &#39;GET, POST, OPTIONS&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Headers&#39;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &#39;Authorization, Content-Type&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    add_header </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;Access-Control-Allow-Credentials&#39;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> &#39;true&#39;</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">    </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">     proxy_pass </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">http://server</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="配置-http-2-连接" tabindex="-1">配置 HTTP/2 连接 <a class="header-anchor" href="#配置-http-2-连接" aria-label="Permalink to &quot;配置 HTTP/2 连接&quot;">​</a></h4><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">http</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 开启 HTTP/2</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">443</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> ssl http2</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 优化连接复用</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  keepalive_timeout </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">300s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  keepalive_requests </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">10000</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 头部压缩优化</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  gzip </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">on</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  gzip_min_length </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">1k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  gzip_comp_level </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">3</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  gzip_types </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">text/plain application/json</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 调整缓冲区 Header</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  http2_max_filed_size</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 16k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  http2_max_header_size </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">64k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 动态调整窗口大小</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  http2_body_preread_size </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">128k</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  http2_streams_index_size</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 1024</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="配置高性能缓存" tabindex="-1">配置高性能缓存 <a class="header-anchor" href="#配置高性能缓存" aria-label="Permalink to &quot;配置高性能缓存&quot;">​</a></h4><h4 id="配置动态黑名单" tabindex="-1">配置动态黑名单 <a class="header-anchor" href="#配置动态黑名单" aria-label="Permalink to &quot;配置动态黑名单&quot;">​</a></h4><h4 id="限制请求方式" tabindex="-1">限制请求方式 <a class="header-anchor" href="#限制请求方式" aria-label="Permalink to &quot;限制请求方式&quot;">​</a></h4><p>HTTP 的全部请求方式如下：</p><ul><li>GET：请求指定的页面信息，并返回实体主体</li><li>HEAD：类似于 GET 请求，只不过返回的响应中没有具体的内容，用于获取报头</li><li>POST：向指定的资源提交数据进行处理请求（例如提交表单或上传文件）。数据被包含在请求体中，POST 请求可能会导致新的资源的建立和/或已有资源的修改</li><li>PUT：从客户端向服务器传送的数据取代指定文档的内容</li><li>DELETE：请求服务器删除指定的页面</li><li>CONNECT：HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器</li><li>OPTIONS：允许客户端查看服务器的性能</li><li>TRACE：回显服务器收到的请求，主要用于测试或诊断</li></ul><p>大部分的网站只支持 GET 和 POST 方法，其他的方法并不会被响应，会抛出 404 或 405 错误，简单的原因如下：</p><ul><li>OPTIONS：将会造成服务器的信息暴露，如中间件的版本等</li><li>PUT：由于 PUT 方法自身不带验证机制，可以简单的利用 PUT 上传 WebShell 或其他恶意文件，从而获取敏感数据或服务器权限</li><li>DELETE：利用 DELETE 方法可以删除服务器上的特定资源，造成恶意攻击</li></ul><p>新增一个请求限制文件：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">vim</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> \${</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">nginx-path</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">/conf/method_deny.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>写入如下内容：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">if</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">request_method</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> !~ </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">^(GET|POST)$</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">) {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 405</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>改配置文件引入在 location 块中，如果需要对接口进行更详细的配置，可以按照如下的方式进行配置，配置于 HTTP 块内：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> /api/api-1 </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_except</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> GET {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  proxy_pass </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">http://api-server</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> /api/api-2 </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_except</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> POST {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  proxy_pass </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">http://api-server</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="限制请求速率" tabindex="-1">限制请求速率 <a class="header-anchor" href="#限制请求速率" aria-label="Permalink to &quot;限制请求速率&quot;">​</a></h4><p>对于一个 IP 的请求而言。需要限制其请求的连接数和请求的速率，用于防止 DOS 攻击，具体的配置如下，配置于 http 块内：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">http</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_conn_zone </span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">binary_remote_addr</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> zone=addr:10m</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_conn </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">addr </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">100</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_req_zone </span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">binary_remote_addr</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> zone=req_zone:10m rate=10r/s</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  limit_req </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">zone=req_zone burst=20 nodelay</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="限制上传文件" tabindex="-1">限制上传文件 <a class="header-anchor" href="#限制上传文件" aria-label="Permalink to &quot;限制上传文件&quot;">​</a></h4><p>对于文件上传，也需要进行限制，防止上传大文件耗尽服务器资源，同时也要限制允许上传大文件类型，防止上传了 WebShell 或其他危险文件，从而对服务器造成危害行为：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> /uploads/ </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  root </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/data/resources</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  client_body_temp_path </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/data/resources/tmp</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  client_max_body</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 10m</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  dav_methods </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">PUT DELETE MKCOL COPY MOVE</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  create_full_put_path </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">on</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  dev_access</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> user:rw group:rw all:r</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  if</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">request_filename</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> ~* </span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">^.*?\\.(php|php5|sh|pl|py)$</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">) {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 403</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="设置防盗链" tabindex="-1">设置防盗链 <a class="header-anchor" href="#设置防盗链" aria-label="Permalink to &quot;设置防盗链&quot;">​</a></h4><h4 id="防止-sql-注入和-xss-攻击" tabindex="-1">防止 SQL 注入和 XSS 攻击 <a class="header-anchor" href="#防止-sql-注入和-xss-攻击" aria-label="Permalink to &quot;防止 SQL 注入和 XSS 攻击&quot;">​</a></h4><p>Nginx 本身并不直接处理 SQL 查询，以下的方式只是减少攻击面，完整的防护需要配合 WAF 和在应用程序层面进行真正地实现，这里不介绍 Nginx 集成 WAF 的具体操作以及结合后 WAF 的配置，只使用 Nginx 本身的功能配置来进行攻击面的减少：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  if</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">request_uri</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> ~* </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">[;</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">&#39;&lt;&gt;] ) {</span></span>
<span class="line"><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">    return 444;</span></span>
<span class="line"><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">  }</span></span>
<span class="line"><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">  </span></span>
<span class="line"><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">  if (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> ~* [;&#39;</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">&lt;&gt;] ) {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 444</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="禁止目录遍历" tabindex="-1">禁止目录遍历 <a class="header-anchor" href="#禁止目录遍历" aria-label="Permalink to &quot;禁止目录遍历&quot;">​</a></h4><p>禁止访问隐藏的文件和目录，防止信息和文件泄漏，具体的配置如下：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> ~</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> /\\. </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  access_log </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">off</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  log_not_found </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">off</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> ~*</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> ^/(uploads|images)/.*\\.(php|php5|sh|pl|py|asp|aspx|jsp)$ </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> / </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  autoindex </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">off</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="禁止爬虫" tabindex="-1">禁止爬虫 <a class="header-anchor" href="#禁止爬虫" aria-label="Permalink to &quot;禁止爬虫&quot;">​</a></h4><p>对于爬虫而言，理论上需要遵守网站的 <code>robots.txt</code> 文件内的内容，但是也有一些爬虫并不会严格遵守该约定，从而导致服务器的负载上升，性能下降，从而导致正常用户的使用体验下降，这是需要在 Nginx 中进行配置拦截。主要配置内容如下：</p><p>首先新建 <code>robots.txt</code> 文件：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">vim</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> robots.txt</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>写入如下内容：</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span>User-agent: *</span></span>
<span class="line"><span>Disallow: /</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后新增 nginx 的配置，该配置需要配置在 <code>server</code> 块下的 <code>location</code> 块内：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  location</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> =</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;"> /robots.txt </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    alias </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">/\${path-to-robots.txt}/robots.txt</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对于不遵守的爬虫程序，还需要根据 UA 来进行禁止：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">server</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  listen </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">443</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> ssl</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  server_name </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">wiki.4r3al.team</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # SSL 配置</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  ...</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 禁止特定爬虫</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  if</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;"> (</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">$</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">http_user_agent</span><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;"> ~* </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">(bot|crawl|spider|scraper)) {</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">    return</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> 403</span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  </span></span>
<span class="line"><span style="--shiki-light:#9893A5;--shiki-light-font-style:italic;--shiki-dark:#6E6A86;--shiki-dark-font-style:italic;">  # 其他的业务配置</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">  ...</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="开启监控" tabindex="-1">开启监控 <a class="header-anchor" href="#开启监控" aria-label="Permalink to &quot;开启监控&quot;">​</a></h4><p>开启 Nginx 自带的监控内容，用于监控 Nginx 的性能，新建 <code>status.conf</code> 文件：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">vim</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;"> \${</span><span style="--shiki-light:#575279;--shiki-light-font-style:italic;--shiki-dark:#E0DEF4;--shiki-dark-font-style:italic;">nginx-path</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">}</span><span style="--shiki-light:#EA9D34;--shiki-dark:#F6C177;">/conf/conf.d/status.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>写入如下内容：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">location</span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;"> /status </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">{</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  stub_status</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  allow </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">127.0.0.1</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  allow </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">::1</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">  deny </span><span style="--shiki-light:#D7827E;--shiki-dark:#EA9A97;">all</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span>
<span class="line"><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="配置高可用" tabindex="-1">配置高可用 <a class="header-anchor" href="#配置高可用" aria-label="Permalink to &quot;配置高可用&quot;">​</a></h2><p>这里 Nginx 作用是作为反向代理服务器使用，且由于上流<strong>没有 LoadBalance 硬件</strong>进行分流和高可用的配置，这时需要使用软件来配置高可用，常用的方式有两种：</p><ul><li>基于 Keepalived 的高可用</li><li>基于 Heartbeat 的高可用</li></ul><p>两者的区别如下：</p><ul><li>Keepalived 使用更简单，但是 Heartbeat 功能更强大</li><li>使用协议不同，Keepalived 使用 VRRP 协议，而 Heartbeat 使用心跳进行通信和选举。</li></ul><p>根据具体情况使用其中的一种高可用方式即可。</p><h3 id="基于-keepalived-的高可用" tabindex="-1">基于 Keepalived 的高可用 <a class="header-anchor" href="#基于-keepalived-的高可用" aria-label="Permalink to &quot;基于 Keepalived 的高可用&quot;">​</a></h3><h3 id="基于-heartbeat-的高可用" tabindex="-1">基于 Heartbeat 的高可用 <a class="header-anchor" href="#基于-heartbeat-的高可用" aria-label="Permalink to &quot;基于 Heartbeat 的高可用&quot;">​</a></h3><h2 id="附录-a" tabindex="-1">附录 A <a class="header-anchor" href="#附录-a" aria-label="Permalink to &quot;附录 A&quot;">​</a></h2>`,95)),a("h3",b,[s[2]||(s[2]=l("完整的 ")),a("a",g,[s[1]||(s[1]=l("nginx.conf")),n(t,{icon:"line-md:downloading-loop"})]),s[3]||(s[3]=l(" 文件 ")),s[4]||(s[4]=a("a",{class:"header-anchor",href:"#完整的-nginx-conf-文件","aria-label":'Permalink to "完整的 <a href="/files/nginx/nginx.conf" download="nginx.conf">nginx.conf<Icon icon="line-md:downloading-loop"/></a> 文件"'},"​",-1))]),s[7]||(s[7]=e('<div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes rose-pine-dawn rose-pine-moon vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#286983;--shiki-dark:#3E8FB0;">user </span><span style="--shiki-light:#575279;--shiki-dark:#E0DEF4;">nginx nginx</span><span style="--shiki-light:#797593;--shiki-dark:#908CAA;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="完整的-proxy-conf-文件" tabindex="-1">完整的 proxy.conf 文件 <a class="header-anchor" href="#完整的-proxy-conf-文件" aria-label="Permalink to &quot;完整的 proxy.conf 文件&quot;">​</a></h3><h3 id="完整的-example-conf-文件" tabindex="-1">完整的 example.conf 文件 <a class="header-anchor" href="#完整的-example-conf-文件" aria-label="Permalink to &quot;完整的 example.conf 文件&quot;">​</a></h3>',3)),n(h),n(k)])}const C=r(o,[["render",y]]);export{x as __pageData,C as default};
